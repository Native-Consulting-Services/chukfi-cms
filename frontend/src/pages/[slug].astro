---
import Layout from "../layouts/Layout.astro";
import type { Block } from "../types/blocks";

export async function getStaticPaths() {
  // For now, return empty array - pages will be client-side only
  // In production, you'd fetch from API or build-time data
  return [];
}

interface Page {
  id: string;
  title: string;
  slug: string;
  blocks: Block[];
  layout: "default" | "full-width" | "sidebar";
  status: "draft" | "published";
  seo: {
    title: string;
    description: string;
    ogImage?: string;
  };
  createdAt: string;
  updatedAt: string;
}

const { slug } = Astro.params;

// This will be hydrated client-side
const pageData: Page | null = null;
---

<Layout title={pageData?.seo?.title || pageData?.title || "Page"}>
  <div id="page-content" data-slug={slug}></div>

  <script>
    import type { Block } from "../types/blocks";

    interface Page {
      id: string;
      title: string;
      slug: string;
      blocks: Block[];
      layout: "default" | "full-width" | "sidebar";
      status: "draft" | "published";
      seo: {
        title: string;
        description: string;
        ogImage?: string;
      };
      createdAt: string;
      updatedAt: string;
    }

    // Load page data from localStorage
    const container = document.getElementById("page-content");
    const slug = container?.getAttribute("data-slug");

    if (!slug) {
      container!.innerHTML = `
        <div class="min-h-screen flex items-center justify-center">
          <div class="text-center">
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">404</h1>
            <p class="text-gray-600 dark:text-gray-400">Page not found</p>
          </div>
        </div>
      `;
    } else {
      const stored = localStorage.getItem("chukfi_pages");
      let page: Page | undefined;

      if (stored) {
        try {
          const pages: Page[] = JSON.parse(stored);
          page = pages.find((p) => p.slug === slug && p.status === "published");
        } catch (e) {
          console.error("Failed to load page", e);
        }
      }

      if (!page) {
        container!.innerHTML = `
          <div class="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
            <div class="text-center px-4">
              <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">404</h1>
              <p class="text-gray-600 dark:text-gray-400 mb-6">Page not found</p>
              <a href="/" class="text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300">Go back home</a>
            </div>
          </div>
        `;
      } else {
        // Update page title
        document.title = page.seo.title || page.title;

        // Update meta description
        const metaDescription = document.querySelector(
          'meta[name="description"]',
        );
        if (metaDescription && page.seo.description) {
          metaDescription.setAttribute("content", page.seo.description);
        }

        // Render blocks
        const blocksHtml = page.blocks
          .map((block) => renderBlock(block))
          .join("");

        const layoutClass =
          page.layout === "full-width"
            ? ""
            : page.layout === "sidebar"
              ? "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"
              : "max-w-6xl mx-auto px-4 sm:px-6 lg:px-8";

        container!.innerHTML = `
          <div class="${layoutClass}">
            ${blocksHtml}
          </div>
        `;
      }
    }

    function renderBlock(block: Block): string {
      switch (block.type) {
        case "hero":
          return renderHeroBlock(block);
        case "wysiwyg":
          return renderWYSIWYGBlock(block);
        case "features":
          return renderFeaturesBlock(block);
        case "cta":
          return renderCTABlock(block);
        case "gallery":
          return renderGalleryBlock(block);
        case "testimonials":
          return renderTestimonialsBlock(block);
        case "faq":
          return renderFAQBlock(block);
        default:
          return "";
      }
    }

    function renderHeroBlock(block: Block): string {
      const content = block.content as any;
      const settings = block.settings || {};
      const bgStyle = content.backgroundImage
        ? `background-image: url('${content.backgroundImage}'); background-size: cover; background-position: center;`
        : "";
      const overlay = content.backgroundOverlay
        ? `<div style="background: rgba(0,0,0,${content.backgroundOverlay / 100}); position: absolute; inset: 0;"></div>`
        : "";

      return `
        <section class="relative py-20 ${settings.className || ""}" style="${bgStyle}">
          ${overlay}
          <div class="relative z-10 max-w-4xl mx-auto text-center px-4">
            <h1 class="text-5xl font-bold text-gray-900 dark:text-white mb-6">${content.heading || ""}</h1>
            <p class="text-xl text-gray-600 dark:text-gray-300 mb-8">${content.subheading || ""}</p>
            <div class="flex flex-wrap gap-4 justify-center">
              ${content.ctaText ? `<a href="${content.ctaLink || "#"}" class="inline-flex items-center rounded-md bg-indigo-600 px-6 py-3 text-base font-medium text-white hover:bg-indigo-700">${content.ctaText}</a>` : ""}
              ${content.secondaryCtaText ? `<a href="${content.secondaryCtaLink || "#"}" class="inline-flex items-center rounded-md border border-gray-300 bg-white px-6 py-3 text-base font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700">${content.secondaryCtaText}</a>` : ""}
            </div>
          </div>
        </section>
      `;
    }

    function renderWYSIWYGBlock(block: Block): string {
      const content = block.content as any;
      const settings = block.settings || {};
      return `
        <section class="py-12 ${settings.className || ""}">
          <div class="prose prose-lg dark:prose-invert max-w-none">
            ${content.html || ""}
          </div>
        </section>
      `;
    }

    function renderFeaturesBlock(block: Block): string {
      const content = block.content as any;
      const settings = block.settings || {};
      const features = content.features || [];

      return `
        <section class="py-16 ${settings.className || ""}">
          ${content.title ? `<h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-4">${content.title}</h2>` : ""}
          ${content.subtitle ? `<p class="text-center text-gray-600 dark:text-gray-400 mb-12">${content.subtitle}</p>` : ""}
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            ${features
              .map(
                (feature: any) => `
              <div class="text-center">
                <div class="text-4xl mb-4">${feature.icon || "âœ¨"}</div>
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">${feature.title}</h3>
                <p class="text-gray-600 dark:text-gray-400">${feature.description}</p>
              </div>
            `,
              )
              .join("")}
          </div>
        </section>
      `;
    }

    function renderCTABlock(block: Block): string {
      const content = block.content as any;
      const settings = block.settings || {};

      return `
        <section class="py-16 bg-indigo-600 dark:bg-indigo-800 ${settings.className || ""}">
          <div class="max-w-4xl mx-auto text-center px-4">
            ${content.heading ? `<h2 class="text-3xl font-bold text-white mb-4">${content.heading}</h2>` : ""}
            ${content.subheading ? `<p class="text-xl text-indigo-100 mb-8">${content.subheading}</p>` : ""}
            ${content.ctaText ? `<a href="${content.ctaLink || "#"}" class="inline-flex items-center rounded-md bg-white px-6 py-3 text-base font-medium text-indigo-600 hover:bg-indigo-50">${content.ctaText}</a>` : ""}
          </div>
        </section>
      `;
    }

    function renderGalleryBlock(block: Block): string {
      const content = block.content as any;
      const settings = block.settings || {};
      const images = content.images || [];

      return `
        <section class="py-16 ${settings.className || ""}">
          ${content.title ? `<h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-12">${content.title}</h2>` : ""}
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            ${images
              .map(
                (image: any) => `
              <div class="relative aspect-square overflow-hidden rounded-lg">
                <img src="${image.url}" alt="${image.alt || ""}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-300" />
                ${image.caption ? `<div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white p-3 text-sm">${image.caption}</div>` : ""}
              </div>
            `,
              )
              .join("")}
          </div>
        </section>
      `;
    }

    function renderTestimonialsBlock(block: Block): string {
      const content = block.content as any;
      const settings = block.settings || {};
      const testimonials = content.testimonials || [];

      return `
        <section class="py-16 bg-gray-50 dark:bg-gray-800 ${settings.className || ""}">
          ${content.title ? `<h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-12">${content.title}</h2>` : ""}
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            ${testimonials
              .map(
                (testimonial: any) => `
              <div class="bg-white dark:bg-gray-700 rounded-lg p-6 shadow-md">
                <p class="text-gray-600 dark:text-gray-300 mb-4">"${testimonial.quote}"</p>
                <div class="flex items-center gap-3">
                  ${testimonial.avatar ? `<img src="${testimonial.avatar}" alt="${testimonial.author}" class="w-12 h-12 rounded-full" />` : ""}
                  <div>
                    <div class="font-semibold text-gray-900 dark:text-white">${testimonial.author}</div>
                    ${testimonial.role ? `<div class="text-sm text-gray-500 dark:text-gray-400">${testimonial.role}</div>` : ""}
                  </div>
                </div>
              </div>
            `,
              )
              .join("")}
          </div>
        </section>
      `;
    }

    function renderFAQBlock(block: Block): string {
      const content = block.content as any;
      const settings = block.settings || {};
      const faqs = content.faqs || [];

      return `
        <section class="py-16 ${settings.className || ""}">
          ${content.title ? `<h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-12">${content.title}</h2>` : ""}
          <div class="max-w-3xl mx-auto space-y-4">
            ${faqs
              .map(
                (faq: any, index: number) => `
              <details class="bg-white dark:bg-gray-800 rounded-lg shadow-sm">
                <summary class="cursor-pointer font-semibold text-gray-900 dark:text-white p-6 hover:bg-gray-50 dark:hover:bg-gray-700">
                  ${faq.question}
                </summary>
                <div class="px-6 pb-6 text-gray-600 dark:text-gray-400">
                  ${faq.answer}
                </div>
              </details>
            `,
              )
              .join("")}
          </div>
        </section>
      `;
    }
  </script>
</Layout>
