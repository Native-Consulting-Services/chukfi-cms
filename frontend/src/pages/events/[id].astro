---
import Layout from "../../layouts/Layout.astro";
import { Calendar, MapPin, Users, ArrowLeft, Clock } from "lucide-react";

// Return empty paths - this page is rendered client-side with dynamic data
export async function getStaticPaths() {
  return [];
}

// This page will be rendered client-side with the event data
---

<Layout title="Event Details">
  <div
    class="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 dark:from-gray-900 dark:via-purple-900/20 dark:to-blue-900/20"
  >
    <div class="mx-auto max-w-4xl px-4 py-8 sm:px-6 lg:px-8">
      <!-- Back Button -->
      <a
        href="/dashboard/events"
        class="mb-6 inline-flex items-center text-sm font-medium text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white"
      >
        <ArrowLeft className="mr-2 h-4 w-4" />
        Back to Events
      </a>

      <!-- Event Details Container -->
      <div
        id="event-container"
        class="rounded-lg bg-white shadow-lg dark:bg-gray-800"
      >
        <!-- Loading State -->
        <div id="loading" class="p-12 text-center">
          <div
            class="mx-auto h-12 w-12 animate-spin rounded-full border-4 border-gray-200 border-t-indigo-600"
          >
          </div>
          <p class="mt-4 text-gray-600 dark:text-gray-400">
            Loading event details...
          </p>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden p-12 text-center">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
            Event Not Found
          </h2>
          <p class="mt-2 text-gray-600 dark:text-gray-400">
            The event you're looking for doesn't exist or has been removed.
          </p>
          <a
            href="/dashboard/events"
            class="mt-6 inline-block rounded-lg bg-indigo-600 px-6 py-3 text-sm font-semibold text-white hover:bg-indigo-700"
          >
            Browse Events
          </a>
        </div>

        <!-- Event Content (populated by JavaScript) -->
        <div id="event-content" class="hidden"></div>
      </div>
    </div>
  </div>

  <script>
    import EventRegistrationForm from "../../components/EventRegistrationForm";
    import { createRoot } from "react-dom/client";
    import { createElement } from "react";

    interface Event {
      id: string;
      title: string;
      description?: string;
      date?: string;
      startDate?: string;
      endDate?: string;
      location?: string;
      capacity?: number;
      current_registrations?: number;
      registrations?: number;
      registration_mode?: string;
      registrationMode?: string;
      status?: string;
    }

    interface Registration {
      id: string;
      event_id: string;
      status: string;
      name: string;
      email: string;
    }

    function getEventDate(event: Event): string {
      return event.startDate || event.date || "";
    }

    function formatDate(dateString: string): string {
      const date = new Date(dateString);
      return date.toLocaleDateString("en-US", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
      });
    }

    function formatTime(dateString: string): string {
      const date = new Date(dateString);
      return date.toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function getEventStatus(event: Event): string {
      const eventDate = new Date(getEventDate(event));
      const now = new Date();

      if (eventDate < now) return "Past";
      const registered =
        event.registrations || event.current_registrations || 0;
      if (event.capacity && registered >= event.capacity) return "Full";
      return "Open";
    }

    function isUserRegistered(
      eventId: string,
      registrations: Registration[],
    ): boolean {
      return registrations.some((reg) => reg.event_id === eventId);
    }

    // Get event ID from URL
    const pathParts = window.location.pathname.split("/");
    const eventId = pathParts[pathParts.length - 1];

    // Load event data
    const storedEvents = localStorage.getItem("chukfi_events");
    const storedRegistrations = localStorage.getItem("chukfi_registrations");
    const userEmail = localStorage.getItem("chukfi_user_email");

    if (!storedEvents) {
      document.getElementById("loading")?.classList.add("hidden");
      document.getElementById("error")?.classList.remove("hidden");
    } else {
      const allEvents: Event[] = JSON.parse(storedEvents);
      const allRegistrations: Registration[] = storedRegistrations
        ? JSON.parse(storedRegistrations)
        : [];

      // Update registration counts
      const registrationCounts = new Map<string, number>();
      allRegistrations.forEach((reg: any) => {
        const count = registrationCounts.get(reg.event_id) || 0;
        registrationCounts.set(reg.event_id, count + 1);
      });

      const events = allEvents.map((event) => ({
        ...event,
        registrations: registrationCounts.get(event.id) || 0,
        current_registrations: registrationCounts.get(event.id) || 0,
      }));

      const event = events.find((e) => e.id === eventId);

      if (!event) {
        document.getElementById("loading")?.classList.add("hidden");
        document.getElementById("error")?.classList.remove("hidden");
      } else {
        // Get user registrations
        const userRegistrations = allRegistrations.filter(
          (reg: any) => reg.user_email === userEmail || reg.email === userEmail,
        );

        const status = getEventStatus(event);
        const registered = isUserRegistered(event.id, userRegistrations);
        const spotsRemaining = event.capacity
          ? event.capacity - (event.registrations || 0)
          : null;

        // Populate event content
        const contentDiv = document.getElementById("event-content");
        if (contentDiv) {
          contentDiv.innerHTML = `
            <div class="p-8">
              <!-- Header -->
              <div class="mb-6">
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                  ${event.title}
                </h1>
                ${registered ? '<span class="mt-2 inline-block rounded-full bg-green-100 px-3 py-1 text-sm font-medium text-green-800 dark:bg-green-900/30 dark:text-green-400">You\'re Registered</span>' : ""}
              </div>

              <!-- Event Details Grid -->
              <div class="mb-8 grid gap-4 sm:grid-cols-2">
                <div class="flex items-start gap-3 rounded-lg bg-gray-50 p-4 dark:bg-gray-700/50">
                  <svg class="mt-0.5 h-5 w-5 text-indigo-600 dark:text-indigo-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                  <div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Date & Time</p>
                    <p class="mt-1 text-gray-900 dark:text-white">${formatDate(getEventDate(event))}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${formatTime(getEventDate(event))}</p>
                  </div>
                </div>

                ${
                  event.location
                    ? `
                <div class="flex items-start gap-3 rounded-lg bg-gray-50 p-4 dark:bg-gray-700/50">
                  <svg class="mt-0.5 h-5 w-5 text-indigo-600 dark:text-indigo-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                  <div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Location</p>
                    <p class="mt-1 text-gray-900 dark:text-white">${event.location}</p>
                  </div>
                </div>
                `
                    : ""
                }

                ${
                  event.capacity
                    ? `
                <div class="flex items-start gap-3 rounded-lg bg-gray-50 p-4 dark:bg-gray-700/50">
                  <svg class="mt-0.5 h-5 w-5 text-indigo-600 dark:text-indigo-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                  <div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Capacity</p>
                    <p class="mt-1 text-gray-900 dark:text-white">
                      ${status === "Full" ? "Event Full" : `${spotsRemaining} spots remaining`}
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${event.registrations || 0} / ${event.capacity} registered</p>
                  </div>
                </div>
                `
                    : ""
                }

                <div class="flex items-start gap-3 rounded-lg bg-gray-50 p-4 dark:bg-gray-700/50">
                  <svg class="mt-0.5 h-5 w-5 text-indigo-600 dark:text-indigo-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                  <div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Status</p>
                    <p class="mt-1 font-semibold ${status === "Past" ? "text-gray-500" : status === "Full" ? "text-red-600 dark:text-red-400" : "text-green-600 dark:text-green-400"}">
                      ${status}
                    </p>
                  </div>
                </div>
              </div>

              <!-- Description -->
              ${
                event.description
                  ? `
              <div class="mb-8">
                <h2 class="mb-3 text-xl font-bold text-gray-900 dark:text-white">About This Event</h2>
                <p class="whitespace-pre-wrap text-gray-600 dark:text-gray-400">${event.description}</p>
              </div>
              `
                  : ""
              }

              <!-- Registration Button -->
              <div id="register-button-container"></div>
            </div>
          `;

          // Show content
          document.getElementById("loading")?.classList.add("hidden");
          contentDiv.classList.remove("hidden");

          // Render registration button
          const buttonContainer = document.getElementById(
            "register-button-container",
          );
          if (buttonContainer) {
            if (registered && status !== "Past") {
              buttonContainer.innerHTML = `
                <button
                  id="unregister-btn"
                  class="w-full rounded-lg border-2 border-red-600 px-6 py-3 font-semibold text-red-600 transition-colors hover:bg-red-50 dark:border-red-500 dark:text-red-500 dark:hover:bg-red-900/20 sm:w-auto"
                >
                  Unregister from Event
                </button>
              `;
              document
                .getElementById("unregister-btn")
                ?.addEventListener("click", () => {
                  if (
                    confirm(
                      "Are you sure you want to unregister from this event?",
                    )
                  ) {
                    const storedRegs = localStorage.getItem(
                      "chukfi_registrations",
                    );
                    if (storedRegs) {
                      const regs = JSON.parse(storedRegs);
                      const updated = regs.filter(
                        (r: any) =>
                          !(
                            r.event_id === event.id &&
                            (r.user_email === userEmail ||
                              r.email === userEmail)
                          ),
                      );
                      localStorage.setItem(
                        "chukfi_registrations",
                        JSON.stringify(updated),
                      );
                      window.location.reload();
                    }
                  }
                });
            } else if (registered && status === "Past") {
              buttonContainer.innerHTML = `
                <button
                  disabled
                  class="w-full cursor-not-allowed rounded-lg bg-gray-300 px-6 py-3 font-semibold text-gray-500 dark:bg-gray-700 dark:text-gray-400 sm:w-auto"
                >
                  Event Ended
                </button>
              `;
            } else if (status === "Past") {
              buttonContainer.innerHTML = `
                <button
                  disabled
                  class="w-full cursor-not-allowed rounded-lg bg-gray-300 px-6 py-3 font-semibold text-gray-500 dark:bg-gray-700 dark:text-gray-400 sm:w-auto"
                >
                  Event Ended
                </button>
              `;
            } else if (status === "Full") {
              buttonContainer.innerHTML = `
                <button
                  disabled
                  class="w-full cursor-not-allowed rounded-lg bg-gray-300 px-6 py-3 font-semibold text-gray-500 dark:bg-gray-700 dark:text-gray-400 sm:w-auto"
                >
                  Event Full
                </button>
              `;
            } else {
              buttonContainer.innerHTML = `<div id="register-form-root"></div>`;
              const root = createRoot(
                document.getElementById("register-form-root")!,
              );

              let showForm = false;
              const renderButton = () => {
                if (showForm) {
                  root.render(
                    createElement(EventRegistrationForm, {
                      event: event,
                      onClose: () => {
                        showForm = false;
                        renderButton();
                      },
                      onSuccess: () => {
                        window.location.reload();
                      },
                    }),
                  );
                } else {
                  const btn = document.createElement("button");
                  btn.className =
                    "w-full rounded-lg bg-indigo-600 px-6 py-3 font-semibold text-white transition-colors hover:bg-indigo-700 sm:w-auto";
                  btn.textContent = "Register for Event";
                  btn.onclick = () => {
                    showForm = true;
                    renderButton();
                  };
                  const container =
                    document.getElementById("register-form-root");
                  if (container) {
                    container.innerHTML = "";
                    container.appendChild(btn);
                  }
                }
              };
              renderButton();
            }
          }
        }
      }
    }
  </script>
</Layout>
