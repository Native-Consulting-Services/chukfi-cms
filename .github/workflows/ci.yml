name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test-frontend:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run frontend tests
        run: |
          cd frontend
          npm run build

      - name: Check TypeScript
        run: |
          cd frontend
          npx astro check

  test-backend:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Install dependencies
        run: |
          cd backend
          go mod tidy

      - name: Run backend tests
        run: |
          cd backend
          go test ./...

      - name: Build backend
        run: |
          cd backend
          go build cmd/server/main.go
          go build cmd/migrate/main.go

  integration-test:
    runs-on: ubuntu-latest
    needs: [test-frontend, test-backend]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend && npm ci && cd ..
          cd backend && go mod tidy && cd ..

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Build backend
        run: |
          cd backend
          go build -o bin/server cmd/server/main.go
          go build -o bin/migrate cmd/migrate/main.go

      - name: Test migrations
        run: |
          cd backend
          mkdir -p data
          # Create .env file for CI
          cat > .env << EOF
          DATABASE_URL=sqlite://./data/chukfi.db
          DB_DRIVER=sqlite
          PORT=8080
          HOST=localhost
          ENVIRONMENT=development
          JWT_SECRET=test-secret-key
          JWT_ACCESS_EXPIRY=15m
          JWT_REFRESH_EXPIRY=7d
          EOF
          ./bin/migrate up

      - name: Start backend server and test
        run: |
          cd backend
          # Start server in background
          nohup ./bin/server > server.log 2>&1 &
          SERVER_PID=$!

          # Wait for server to start
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/health > /dev/null; then
              echo "Server started successfully"
              break
            fi
            echo "Attempt $i: Server not ready yet, waiting..."
            sleep 2
          done

          # Test health endpoint
          echo "Testing health endpoint..."
          response=$(curl -s http://localhost:8080/health)
          echo "Response: $response"

          if [[ "$response" == *"ok"* ]]; then
            echo "✅ Health check passed"
          else
            echo "❌ Health check failed"
            echo "Server logs:"
            cat server.log || echo "No server logs available"
            kill $SERVER_PID || true
            exit 1
          fi

          # Cleanup
          kill $SERVER_PID || true
